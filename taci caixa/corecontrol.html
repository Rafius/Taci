<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1">
<!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->
<meta name="description" content="">
<meta name="author" content="">
<link rel="icon" href="assets/favicon.ico">

<title>TAS TestConsole suite</title>

<!-- TAS core CSS -->
<link href="css/tas-console.css" rel="stylesheet">

<!-- Custom styles for this template -->
<link href="css/theme.css" rel="stylesheet">

<!-- Bootstrap core CSS -->
<link href="css/bootstrap.css" rel="stylesheet">
<!-- Bootstrap theme -->
<link href="css/bootstrap-theme.css" rel="stylesheet">

<!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
<!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
</head>

<body style="padding-bottom: 0px;">
	<!-- Sidebar -->

	<!--<script src="webLocal/js/external/jquery/jquery.js"></script>-->
	<script src="js/tas-console.js"></script>
	<script src="js/jquery-min.js"></script>
	<script src="js/jquery-ui.min.js"></script>


	<!-- Main jumbotron for a primary marketing message or call to action -->
	<div class="page-header">
		<h3>CORE CONTROL CONSOLE</h3>
	</div>

	<button class="btn btn-default" style="width: 20.5%; margin-left: 2%; margin-right: 2%;" id="connectBL" onclick="control(0)">Basic</button>
	<button class="btn btn-default" style="width: 20.5%; margin-left: 2%; margin-right: 2%;" id="connectML" onclick="control(1)">Management</button>
	<button class="btn btn-default" style="width: 20.5%; margin-left: 2%; margin-right: 2%;" id="connectDL" onclick="control(2)">Devices</button>
	<button class="btn btn-default" style="width: 20.5%; margin-left: 2%; margin-right: 2%;" id="connectJL" onclick="control(3)">Judas</button>

	<hr>
	<div id="itemsPlace"></div>
	<hr>

	<button class="btn btn-danger hidden" style="width: 20.5%; margin-left: 2%; margin-right: 2%;" id="btnStop" onclick="stopLayer()">Stop layer</button>
	
	<div id="bottomInPage"></div>
	
	<script type="text/javascript">
		var wsks = [];
		var urBA = 'ws://' + getServer() + ':1714/orchestrator';
		var urML = 'ws://' + getServer() + ':1716/component';
		var urDL = 'ws://' + getServer() + ':1718/device';
		var urJD = 'ws://' + getServer() + ':1720/versioncontrol';

		var urls = [ urBA, urML, urDL, urJD ];
		var btns = [ "#connectBL", "#connectML", "#connectDL", "#connectJL" ];
		var currentNumLayer = 0;

		function control(numLayer) {
			$("#btnStop").addClass('hidden');
			$(btns[currentNumLayer]).removeClass('btn-corecontrol');
			$(btns[currentNumLayer]).addClass('btn-default');
			currentNumLayer = numLayer;
			$(btns[currentNumLayer]).removeClass('btn-default');
			$(btns[currentNumLayer]).addClass('btn-corecontrol');
			if (wsks[currentNumLayer] == null) {
				wsks[currentNumLayer] = connectToWS(urls[currentNumLayer], wsks[currentNumLayer]);
			} else {
				afterOpen();
			}
			$( "#itemsPlace" ).click();
		}
		function prepareToShow(){
			adjustSizes();
		}
		function adjustSizes() {
			var theBottom = document.getElementById('bottomInPage').getBoundingClientRect().bottom;
			parent.document.getElementById('divcorecontrol').setAttribute('height', (theBottom + 60) + 'px')
		}
		function stopLayer() {
			sendMessageWS(wsks[currentNumLayer], '{"component":"coreControl", "request":{"method":"stop","fields":[]}}');
		}
		function afterOpen() {
			clearAll();
			sendMessageWS(wsks[currentNumLayer], '{"header":{"idRequest":"testConsoleCoreControl"}, "component":"coreControl", "request":{"method":"getComponentInfoList","fields":[{"value":"com.caixabank.tas.core.commons.model.component.IComponent"}]}}');
		}
		function afterError() {
			wsks[currentNumLayer] = null;
			clearAll();
			adjustSizes();
		}
		function clearAll() {
			clearLog();
			var list = document.getElementById("itemsPlace");
			while (list.hasChildNodes()) {
				list.removeChild(list.childNodes[0]);
			}
			parent.document.getElementById('divcorecontrol').setAttribute('height', '10000px')
		}
		function messageReceived(res) {
			console.log("messageReceived in corecontrol");
			if (res.component == "coreControl") {
				var lastPrior = "NONE";
				var numComponents = 0;
				var numExtras = 0;

				//console.log(res.response.method);
				if (res.header.idRequest=="testConsoleCoreControl" && res.response.method == "getComponentInfoList") {
					var componentsList = res.response.fields[0].value;
					var cLen = componentsList.length;
					var components = [];

					//console.log(componentsList.length);

					for (i = 0; i < cLen; i++) {
						//console.log(componentsList[i].componentId);

						var newComponent = {};
						newComponent.componentName = componentsList[i].componentId;
						newComponent.priority = componentsList[i].priority;
						newComponent.interfaceName = componentsList[i].componentInterfaceName;
						newComponent.componentClassName = componentsList[i].componentClassName;

						newComponent.extraKeys = {};
						newComponent.extraValues = {};
						var extras = 0;
						for ( var key in componentsList[i]) {
							if (key != "componentId" && key != "priority" && key != "componentInterfaceName" && key != "componentClassName") {
								//console.log(key + "=" + componentsList[i][key]);
								newComponent.extraKeys[extras] = key;
								newComponent.extraValues[extras] = componentsList[i][key];
								extras++;
							}
						}
						numExtras = extras;
						try {
							var pack = newComponent.componentName.split(".");
							newComponent.componentName = pack[pack.length - 1];
						} catch (err) {
						}
						newComponent.componentName = newComponent.componentName.replace("ParametersMapsManagementComponent", "ParametersManager");

						try {
							var pack = newComponent.interfaceName.split(".");
							newComponent.interfaceLayer = pack[3];
							newComponent.interfaceClass = pack[pack.length - 1];
						} catch (err) {
							//never mind, we just tries if it exists
						}

						try {
							var pack = newComponent.componentClassName.split(".");
							newComponent.layer = pack[3];
							newComponent.component = pack[5];
							newComponent.classIdent = pack[6];
							for (j = 7; j < 10; j++) {
								if (pack[j] != null) {
									newComponent.classIdent += "." + pack[j];
								}
							}
						} catch (err) {
							//never mind, we just tries if it exists
						}

						components[numComponents] = newComponent;
						//console.log("element: " + numComponents + ": " + components[numComponents].componentName);
						numComponents++;
					}
					var isSorted = false;
					while (!isSorted) {
						isSorted = true;
						for (i = 0; i < numComponents - 1; i++) {
							if (getPriority(components[i + 1].priority) < getPriority(components[i].priority)) {
								isSorted = false;
								var tmpComponent = components[i];
								components[i] = components[i + 1];
								components[i + 1] = tmpComponent;
							}
						}
					}
					var lastPrior = "NONE";
					var canvasRow = document.createElement("div");
					canvasRow.className = "row";
					canvasRow.style = "width: 100%; margin: 0px;";
					for (i = 0; i < numComponents; i++) {
						//console.log("element: " + i + ": " + components[i].componentName);

						var canvas = document.createElement("div");
						canvas.id = "myId" + components[i].componentName;
						canvas.className = "col-sm-4";

						var canvasBox = document.createElement("div");
						canvasBox.className = "panel panel-info";

						var canvasHead = document.createElement("div");
						canvasHead.className = "panel-heading";
						var myColor = getColorByPriority(components[i].priority);
						canvasHead.style = "background-image: linear-gradient(to bottom," + myColor + " 0," + myColor + " 100%);";
						canvasHead.innerHTML = "<h3 class='panel-title' style='color: #ffffff;'><strong>" + components[i].componentName + "</strong></h3>";
						canvasBox.appendChild(canvasHead);

						var canvasBody = document.createElement("div");
						canvasBody.className = "panel-body";
						canvasBody.setAttribute('style', 'white-space: nowrap;');

						canvasBody.innerHTML = "<strong>Priority: </strong>" + components[i].priority + "<br>";
						//canvasBody.innerHTML += components[i].className + "<br>" ;
						canvasBody.innerHTML += "<strong>Interface id: </strong>" + components[i].interfaceLayer + "<br>";
						canvasBody.innerHTML += "<strong>Interface class: </strong>" + components[i].interfaceClass + "<br>";
						canvasBody.innerHTML += "<strong>Layer id: </strong>" + components[i].layer + "<br>";
						canvasBody.innerHTML += "<strong>Package id: </strong>" + components[i].component + "<br>";
						canvasBody.innerHTML += "<strong>Class: </strong>" + components[i].classIdent;
						for (extra = 0; extra < numExtras; extra++) {
							canvasBody.innerHTML += "<br><strong>" + components[i].extraKeys[extra] + ": </strong>" + components[i].extraValues[extra];
						}
						//canvasBody.innerHTML += "<p style='font-size:12px'>" + components[i].interfaceName.replace("com.caixabank.tas.","") + "</p>";
						//canvasBody.innerHTML += "<p style='font-size:12px'>" + components[i].componentClassName.replace("com.caixabank.tas.","") + "</p>";
						canvasBox.appendChild(canvasBody);
						canvas.appendChild(canvasBox);

						//if(lastPrior!="NONE" && lastPrior!=components[i].priority){
						//	document.getElementById('itemsPlace').appendChild(canvasRow);
						//	document.getElementById('itemsPlace').appendChild(document.createElement("hr"));
						//	canvasRow = document.createElement("div");
						//	canvasRow.className = "row";
						//	canvasRow.style = "width: 100%";
						//}
						lastPrior = components[i].priority;
						canvasRow.appendChild(canvas);
					}
					document.getElementById('itemsPlace').appendChild(canvasRow);
					$("#btnStop").removeClass('hidden');
				} else if (res.response.method == "stop") {
					afterOpen();
				}
				setTimeout(function() {
					adjustSizes();
				}, 50);

			}
		}
		function getPriority(priority) {
			var priorities = [ "TOP", "UPPERHIGH", "HIGH", "UNDERHIGH", "MEDIUM", "UPPERLOW", "LOW", "UNDERLOW", "BOTTOM" ];
			var result = 100;
			for (result = 0; result < priorities.length; result++) {
				if (priority == priorities[result]) {
					break;
				}
			}
			return result;
		}
		function getColorByPriority(priority) {
			var colors = [ "#193C59", "#24567F", "#285F8C", "#2C6899", "#3072A5", "#357CB2", "#3987BF", "#3D90CC", "#4199D8" ];
			try {
				return colors[getPriority(priority)];
			} catch (err) {
				return colors[0];
			}
		}
	</script>
</body>
</html>
