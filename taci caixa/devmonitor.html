<!DOCTYPE html>
<html lang="en" class="nosliders" style="padding-top: 30px;">
<head>
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1">
<!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->
<meta name="description" content="">
<meta name="author" content="">
<link rel="icon" href="assets/favicon.ico">

<title>TAS TestConsole suite</title>

<!-- TAS core CSS -->
<link href="css/tas-console.css" rel="stylesheet">

<!-- Custom styles for this template -->
<link href="css/theme.css" rel="stylesheet">

<!-- Bootstrap core CSS -->
<link href="css/bootstrap.css" rel="stylesheet">
<!-- Bootstrap theme -->
<link href="css/bootstrap-theme.css" rel="stylesheet">

<!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
<!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
</head>

<body style="padding: 20px 0px 0px 0px;">

	<script src="js/tas-console.js"></script>
	<script src="js/jquery-min.js"></script>
	<script src="js/jquery-ui.min.js"></script>

	<div id="divdevices" style="padding: 20px 0px 0px 0px;">
		<div class="row" style="width: 100%">
			<div class="col-sm-12" id="devicesarea"></div>
		</div>
	</div>
	<script>
		var wsDL;
		var neverShowedBefore = true;

		//checkDLConnection();

		function checkDLConnection() {
			console.log('parent.wsks[2]=' + parent.wsks[2]);
			if (parent.wsks[2] != null) {
				wsDL = parent.wsks[2];
				setTimeout(function() {
					afterOpenDL();
				}, 1000);
			} else {
				repaintDevices();
				setTimeout(function() {
					checkDLConnection();
				}, 5000);
			}
		}

		addDevices();
		var lastDevice;

		function addDevices() {
			var papar = document.getElementById("devicesarea");
			for (i = 0; i < devicesList.length; i++) {
				var element = document.createElement('button');
				element.className = 'btn btn-sm btn-default monitorizer';
				element.setAttribute("style", "margin: 1%; width: 18%; height: 105px;");
				lastDevice = "button" + devicesList[i];
				element.setAttribute("id", lastDevice);
				papar.appendChild(element);
			}
			repaintDevices();
		}

		function repaintDevices() {
			if(neverShowedBefore) {
				neverShowedBefore = false;
				checkDLConnection();
			}
			if (devicesList != null) {
				for (i = 0; i < devicesList.length; i++) {
					try {
						var element = document.getElementById("button" + devicesList[i]);
						element.className = 'btn btn-sm btn-default monitorizer';
						var innerText = '<strong>' + devicesList[i].substring(0, 17) + '</strong>';
						innerText += '<br/>DISCONNECTED<br/><span class="glyphicon glyphicon-off"></span>';
						element.innerHTML = innerText;
					} catch (err) {
						console.log('devicesList[i]: ' + devicesList[i] + ' ' + err);
					}
				}
			}
		}
		function prepareToShow(){
			adjustSizes();
		}
		function adjustSizes() {
			var mainBody = parent.document.getElementById('mainBody');
			var theTop = mainBody.getBoundingClientRect().top;
			var theBottom = parent.window.innerHeight;
			console.log('top: ' + theTop);
			console.log('bottom: ' + theBottom);
			console.log("window heigh: " + $(window).height());

			var x = document.getElementsByClassName("monitorizer");
			for (var i = 0; i < x.length; i++) {
				var alt = (((theBottom - 40) / 5) - 38);
				x[i].style.height = alt + 'px';
			}

			theBottom = document.getElementById(lastDevice).getBoundingClientRect().bottom;
			parent.document.getElementById('divdevmonitor').setAttribute('height', (theBottom - theTop + 18) + 'px');
			console.log(parent.document.getElementById('divdevmonitor').getAttribute('height'));
		}

		function afterOpenDL() {
			sendMessageWS(wsDL, '{"header" : {"idRequest" : "testConsoleDevMonitor" }, "component" : "coreControl", "request" : {"method":"getComponentInfoList","fields":[{"value":"com.caixabank.tas.lowinterface.common.device.IDeviceComponent"}]}}');
		}

		function messageReceived(res) {
			console.log('messageReceived in devmonitor');
			if (res.code == 'OK') {
				if (res.response.method == 'addInfoObserver' || res.response.method == 'getDeviceInfo') {
					var qui = res.component.replace("Device", "");
					var estat = res.response.fields[0].value.logicalStatus;
					pintaButo(qui, estat);
				}
				if (res.header.idRequest == "testConsoleDevMonitor" && res.response.method == 'getComponentInfoList') {
					var quantsArrancats = res.response.fields[0].value.length;
					var elsArrancats = res.response.fields[0].value;

					for (var i = 0; i < devicesList.length; i++) {
						document.getElementById("button" + devicesList[i]).className = 'btn btn-sm btn-default monitorizer';
						var arrencat = false;
						for (var j = 0; j < quantsArrancats; j++) {
							if ((devicesList[i] + 'Device') == elsArrancats[j].componentId) {
								arrencat = true;
								break;
							}
						}
						if (arrencat) {
							console.log("Asking for " + (devicesList[i] + 'Device'));
							sendMessageWS(wsDL, '{"header":{"idRequest":"testConsole" }, "component":"' + devicesList[i] + 'Device", "request":{ "method" : "addInfoObserver", "fields" : [{ "value" : "deviceManager_testconsole_' + Math.floor(Math.random() * (10000))
									+ '" }, {"type" : "CALLBACK","className" : "com.caixabank.tas.lowinterface.common.device.IDeviceCallback"}]}}');
							sendMessageWS(wsDL, '{"header":{"idRequest":"testConsole" }, "component":"' + devicesList[i] + 'Device", "request":{ "method":"getDeviceInfo", "fields":[]}}');
						}
					}
				}
			}

		}
		function pintaButo(qui, estat) {
			var butname = '';
			for (i = 0; i < devicesList.length; i++) {
				//console.log(devicesList[i] + " == " + qui);
				if (devicesList[i] == qui) {
					butname = "button" + devicesList[i];
					break;
				}
			}
			console.log("estat: " + estat);
			console.log("butname: " + butname);
			var innerText = '<strong>' + qui.substring(0, 17) + '</strong><br/>';
			innerText += estat + '<br/>';
			innerText += '<span class="glyphicon ';

			if (estat == "INSERVICE") {
				document.getElementById(butname).className = 'btn btn-sm btn-success monitorizer';
				innerText += 'glyphicon-ok';
			}
			if (estat == "OUTOFSERVICE") {
				document.getElementById(butname).className = 'btn btn-sm btn-danger monitorizer';
				innerText += 'glyphicon-wrench';
			}
			if (estat == "NOTINSTALLED") {
				document.getElementById(butname).className = 'btn btn-sm btn-warning monitorizer';
				innerText += 'glyphicon-remove';
			}
			if (estat == "INITIALIZATING") {
				document.getElementById(butname).className = 'btn btn-sm btn-info monitorizer';
				innerText += 'glyphicon-time';
			}
			if (estat == "SUSPENDED") {
				document.getElementById(butname).className = 'btn btn-sm btn-primary monitorizer';
				innerText += 'glyphicon-warning-sign';
			}
			innerText += '"></span>';
			document.getElementById(butname).innerHTML = innerText;
		}
	</script>
</body>
</html>
